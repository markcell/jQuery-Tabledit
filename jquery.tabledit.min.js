/*!
 * Tabledit v1.2.3 (https://github.com/markcell/jQuery-Tabledit)
 * Copyright (c) 2015 Celso Marques
 * Licensed under MIT (https://github.com/markcell/jQuery-Tabledit/blob/master/LICENSE)
 */

if("undefined"==typeof jQuery)throw new Error("Tabledit requires jQuery library.");!function(t){"use strict";t.fn.Tabledit=function(e){function n(e){var n=o.find(".tabledit-input").serialize()+"&action="+e,i=r.onAjax(e,n);if(i===!1)return!1;var a=t.post(r.url,n,function(t,n,i){e===r.buttons.edit.action&&(u.removeClass(r.dangerClass).addClass(r.warningClass),setTimeout(function(){o.find("tr."+r.warningClass).removeClass(r.warningClass)},1400)),r.onSuccess(t,n,i)},"json");return a.fail(function(t,n,i){e===r.buttons["delete"].action?(b.removeClass(r.mutedClass).addClass(r.dangerClass),b.find(".tabledit-toolbar button").attr("disabled",!1),b.find(".tabledit-toolbar .tabledit-restore-button").hide()):e===r.buttons.edit.action&&u.addClass(r.dangerClass),r.onFail(t,n,i)}),a.always(function(){r.onAlways()}),a}function i(t){a(t),d(t),s(t)}function a(t){r.hideIdentifier&&t.find("td:eq("+parseInt(r.columns.identifier[0])+")").hide();var e=t.find("td:eq("+parseInt(r.columns.identifier[0])+")"),n='<span class="tabledit-span tabledit-identifier">'+e.text()+"</span>",i='<input class="tabledit-input tabledit-identifier" type="hidden" name="'+r.columns.identifier[1]+'" value="'+e.text()+'" disabled>';e.html(n+i),e.parent("tr").attr(r.rowIdentifier,e.text())}function d(e){for(var n=0;n<r.columns.editable.length;n++){var i=e.find("td:nth-child("+(parseInt(r.columns.editable[n][0])+1)+")");i.each(function(){var e=t(this).text();r.editButton||t(this).css("cursor","pointer");var i='<span class="tabledit-span">'+e+"</span>";if("undefined"!=typeof r.columns.editable[n][2]){var a='<select class="tabledit-input '+r.inputClass+'" name="'+r.columns.editable[n][1]+'" style="display: none;" disabled>';t.each(jQuery.parseJSON(r.columns.editable[n][2]),function(t,n){a+=e===n?'<option value="'+t+'" selected>'+n+"</option>":'<option value="'+t+'">'+n+"</option>"}),a+="</select>"}else var a='<input class="tabledit-input '+r.inputClass+'" type="text" name="'+r.columns.editable[n][1]+'" value="'+t(this).text()+'" style="display: none;" disabled>';t(this).html(i+a),t(this).addClass("tabledit-view-mode")})}}function s(t){if(r.editButton||r.deleteButton){var e="",n="",i="",a="",d="";r.editButton&&(e='<button type="button" class="tabledit-edit-button '+r.buttons.edit["class"]+'" style="float: none;">'+r.buttons.edit.html+"</button>"),r.deleteButton&&(n='<button type="button" class="tabledit-delete-button '+r.buttons["delete"]["class"]+'" style="float: none;">'+r.buttons["delete"].html+"</button>",d='<button type="button" class="tabledit-confirm-button '+r.buttons.confirm["class"]+'" style="display: none; float: none;">'+r.buttons.confirm.html+"</button>"),r.editButton&&r.saveButton&&(i='<button type="button" class="tabledit-save-button '+r.buttons.save["class"]+'" style="display: none; float: none;">'+r.buttons.save.html+"</button>"),r.deleteButton&&r.restoreButton&&(a='<button type="button" class="tabledit-restore-button '+r.buttons.restore["class"]+'" style="display: none; float: none;">'+r.buttons.restore.html+"</button>");var s='<div class="tabledit-toolbar '+r.toolbarClass+'" style="text-align: left;">\n                                   <div class="'+r.groupClass+'" style="float: none;">'+e+n+"</div>\n                                   "+i+"\n                                   "+d+"\n                                   "+a+"\n                               </div></div>";t.append('<td style="white-space: nowrap; width: 1%;">'+s+"</td>")}}if(!this.is("table"))throw new Error("Tabledit only works when applied to a table.");var o=this,l={url:window.location.href,useAJAX:!0,inputClass:"form-control input-sm",toolbarClass:"btn-toolbar",groupClass:"btn-group btn-group-sm",dangerClass:"danger",warningClass:"warning",mutedClass:"text-muted",eventType:"click",rowIdentifier:"id",hideIdentifier:!1,autoFocus:!0,editButton:!0,deleteButton:!0,saveButton:!0,restoreButton:!0,buttons:{edit:{"class":"btn btn-sm btn-default",html:'<span class="glyphicon glyphicon-pencil"></span>',action:"edit"},"delete":{"class":"btn btn-sm btn-default",html:'<span class="glyphicon glyphicon-trash"></span>',action:"delete"},save:{"class":"btn btn-sm btn-success",html:"Save"},restore:{"class":"btn btn-sm btn-warning",html:"Restore",action:"restore"},confirm:{"class":"btn btn-sm btn-danger",html:"Confirm"}},onDraw:function(){},onSuccess:function(){},onFail:function(){},onAlways:function(){},onAjax:function(){}},r=t.extend(!0,l,e),u="undefined",b="undefined",c="undefined",f={columns:{init:function(){var e=o.find("tbody tr");t.each(e,function(){i(t(this))})}}},p={view:function(e){var n=t(e).parent("tr");t(e).parent("tr").find(".tabledit-input.tabledit-identifier").prop("disabled",!0),t(e).find(".tabledit-input").blur().hide().prop("disabled",!0),t(e).find(".tabledit-span").show(),t(e).addClass("tabledit-view-mode").removeClass("tabledit-edit-mode"),r.editButton&&(n.find("button.tabledit-save-button").hide(),n.find("button.tabledit-edit-button").removeClass("active").blur())},edit:function(e){v.reset(e);var n=t(e).parent("tr");n.find(".tabledit-input.tabledit-identifier").prop("disabled",!1),t(e).find(".tabledit-span").hide();var i=t(e).find(".tabledit-input");i.prop("disabled",!1).show(),r.autoFocus&&i.focus(),t(e).addClass("tabledit-edit-mode").removeClass("tabledit-view-mode"),r.editButton&&(n.find("button.tabledit-edit-button").addClass("active"),n.find("button.tabledit-save-button").show())}},h={reset:function(e){t(e).each(function(){var e=t(this).find(".tabledit-input"),n=t(this).find(".tabledit-span").text();e.is("select")?e.find("option").filter(function(){return t.trim(t(this).text())===n}).attr("selected",!0):e.val(n),p.view(this)})},submit:function(e){var i=r.useAJAX===!0?n(r.buttons.edit.action):!0;i!==!1&&(t(e).each(function(){var e=t(this).find(".tabledit-input");t(this).find(".tabledit-span").text(e.is("select")?e.find("option:selected").text():e.val()),p.view(this)}),u=t(e).parent("tr"))}},v={reset:function(){o.find(".tabledit-confirm-button").hide(),o.find(".tabledit-delete-button").removeClass("active").blur()},submit:function(e){v.reset(e),t(e).parent("tr").find("input.tabledit-identifier").attr("disabled",!1);var i=r.useAJAX===!0?n(r.buttons["delete"].action):!0;t(e).parents("tr").find("input.tabledit-identifier").attr("disabled",!0),i!==!1&&(t(e).parent("tr").addClass("tabledit-deleted-row"),t(e).parent("tr").addClass(r.mutedClass).find(".tabledit-toolbar button:not(.tabledit-restore-button)").attr("disabled",!0),t(e).find(".tabledit-restore-button").show(),b=t(e).parent("tr"))},confirm:function(e){o.find("td.tabledit-edit-mode").each(function(){h.reset(this)}),t(e).find(".tabledit-delete-button").addClass("active"),t(e).find(".tabledit-confirm-button").show()},restore:function(e){t(e).parent("tr").find("input.tabledit-identifier").attr("disabled",!1);var i=r.useAJAX===!0?n(r.buttons.restore.action):!0;t(e).parents("tr").find("input.tabledit-identifier").attr("disabled",!0),i!==!1&&(t(e).parent("tr").removeClass("tabledit-deleted-row"),t(e).parent("tr").removeClass(r.mutedClass).find(".tabledit-toolbar button").attr("disabled",!1),t(e).find(".tabledit-restore-button").hide(),c=t(e).parent("tr"))}};return f.columns.init(),r.onDraw(),r.deleteButton&&(o.on("click","button.tabledit-delete-button",function(e){if(e.handled!==!0){e.preventDefault();var n=t(this).hasClass("active"),i=t(this).parents("td");v.reset(i),n||v.confirm(i),e.handled=!0}}),o.on("click","button.tabledit-confirm-button",function(e){if(e.handled!==!0){e.preventDefault();var n=t(this).parents("td");v.submit(n),e.handled=!0}})),r.restoreButton&&o.on("click","button.tabledit-restore-button",function(e){e.handled!==!0&&(e.preventDefault(),v.restore(t(this).parents("td")),e.handled=!0)}),r.editButton?(o.on("click","button.tabledit-edit-button",function(e){if(e.handled!==!0){e.preventDefault();var n=t(this),i=n.hasClass("active");h.reset(o.find("td.tabledit-edit-mode")),i||t(n.parents("tr").find("td.tabledit-view-mode").get().reverse()).each(function(){p.edit(this)}),e.handled=!0}}),o.on("click","button.tabledit-save-button",function(e){e.handled!==!0&&(e.preventDefault(),h.submit(t(this).parents("tr").find("td.tabledit-edit-mode")),e.handled=!0)})):(o.on(r.eventType,"tr:not(.tabledit-deleted-row) td.tabledit-view-mode",function(t){t.handled!==!0&&(t.preventDefault(),h.reset(o.find("td.tabledit-edit-mode")),p.edit(this),t.handled=!0)}),o.on("change","select.tabledit-input:visible",function(){event.handled!==!0&&(h.submit(t(this).parent("td")),event.handled=!0)}),t(document).on("click",function(t){var e=o.find(".tabledit-edit-mode");e.is(t.target)||0!==e.has(t.target).length||h.reset(o.find(".tabledit-input:visible").parent("td"))})),t(document).on("keyup",function(t){var e=o.find(".tabledit-input:visible"),n=o.find(".tabledit-confirm-button");if(e.length>0)var i=e.parents("td");else{if(!(n.length>0))return;var i=n.parents("td")}switch(t.keyCode){case 9:r.editButton||(h.submit(i),p.edit(i.closest("td").next()));break;case 13:h.submit(i);break;case 27:h.reset(i),v.reset(i)}}),this.applyToRow=function(t){i(t)},this}}(jQuery);